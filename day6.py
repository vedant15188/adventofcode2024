import copy
from tqdm import tqdm

puzzle_input="""..........#..........#.#.......................................................................#...............#......#...#.......
........................................#..#..........#.........#..#..............................................................
.........#.......................................................................................................#................
..................................#.#..................................#..#.......#.....#.#............#.#........................
...#.......................................................#.........#...................#.................#......................
...............#.........#...........#................................................#..............#...........#.............#..
...................#..#..................................................................#........................................
........##..............................##................................#.....................#...#.............................
................................#...................#...........#.#...........................................................#...
......#......#...........................................#............................................#...#..#....#...............
............................#...#......#.....#.........#...#..#..............#....#...................#.........................#.
....................##.#........#.........#.............#......................#.#....#..............#........................#..#
#....................#......#..........#................................................................................#.........
..............#.............................................................#..........................#........#.....#..........#
.....................#........#......##.#.........#..........#.##.......................................#....#....................
................................................................#..#...........#.........#........................................
...............#..........#..#....#.#.#..................................#................................#..................#....
...................#....#.........................................................................................................
....#........................................................#......#......#.......................................#............#.
................................................#...#...........................................................#.................
..............#............................#.#.........................................#....#.....................................
...........#....#......#..................................................................#.....#..........#.............#.#......
...........................................#........#.#.........#.................#.....#.........................................
.............#.........#.........................#......#.....................#.#.................................................
.............#.....#................#...................................................#.........................................
..#....#............#................#...........................#..................#............#................................
#............................................................#......#..................................#...............#.......#..
.........................#...#.................................................................#..#...........................#..#
.................#.......................................#...............................#...#...#............#..........#........
......................#.........#...............#......#................................#.#....#.......#..........................
.#......##.................................#.................#...#.................#............................................#.
..#..................#.....#.#......#................................#..#...#......##....#..........#..................#..........
.................................................................................#...................................#............
..............................#..#...............................#....#.............................#.......#..................#..
..........#........#.....................................#..............#.....#..#................#........#.#..................#.
....................................#....#..........#........##...................................................................
.......#............................##.......#....#................................................................#.#............
.......................#......................................................#.................#.................................
.......#...................#..................................................................................................#...
.........#.....#................................#...............#........#.....................................#................#.
..#...........................#.....#..........#............................................#........#........#.#.................
...#.........#.............................#......#......................#.......................................#.......#.......#
.........................#.........#........#....................#..................#....#...#.................#..................
...............#.....................................................#....#....^............#.....................................
.......#.......#.....#.............#...........#...#..................................#...#.#....#.........................#......
.............#....................#..................................................#.........................#..................
......................................................##..........................................................................
.....................................#.....................................................................#............#..#....#.
#......................#....................#...#..................#....#.......................................#........#........
.#.....................................................................#...........................#....................##........
............#............#.........................#.........#.....................#..#........#...............................#..
.......#..#...........................................................#..#........#................#................#.............
..............................................................................................................#...................
..#............................#.....#.............#...............#..................................................#...........
..#........#..........................................................................#...........#.....##...................#....
..#.........#...................................#.................................................................................
...#.#......................#.......#...........#.........................................................#..........#............
.............#......#............#............................................................#......#............................
..............#......#...................................................................................................#........
..............#.#............................................................................#......##............................
...........#....................#...................#......#..............#.........................#.....#...#.............#.....
.................#......#................................................................................#...............#........
..#...........................................................................................#...................................
#.............#.......................#..#.....................................#..#.....#.....................#...................
.........#..#...#......#.......#................................#..............#.........#..........................#......#......
.....##...........#................................................................................................#..........#...
.#.........#....................................................##.............................#...#.........#....................
............#...............................#.#...............................................#...............................#...
...............................#..................#...........................#..............................................#....
.#..........#....#.............#.....#.....................#.....................#...................#.........................#..
.............................................................#................##..............#...................#...............
..........................##.........#................................................................................#...........
........#..#...........................#...................................................................#......................
..#.....#...................................................................#.....#....#..#.......#.......#.....#.....#...........
....................................#.......#....#......................................#........................#...........#....
...............#..............#.................#...............#....#....................................................#.......
....#..................#..........................................................................#.......#..........#............
..#...................................................#...............#...............................#......#................#...
.......#............#............................#.......................................#...#....................##..............
...............................#.......#................................#..............#....................#.....................
...........................#..............................................#..........................................#.#..#.......
....#........#....................#...........................................................................................#...
#..................#.....................#....................................#.#............#...................#................
....#........#...#............................#...#.......................#...............#........#....#.........................
.............................................................................................#....#...............#..#............
.........#..........#...........................................................#.#........................#..................#...
.....................................#................#.........#.#..........##......................#..#.........................
.....#..#.....................................................................#.#................................##...............
...............................#....#.#..................................................#.#.........................#........#...
#.......................................##.....#..........................#..#....................#.........#..........#..........
......#.#.............#....##...................................................................#................#....#......#....
..................#...#........................................#........................................#...#.....................
....................#...#...........##...................#..#....#.............................#......#............#..............
.........#.........................................................................#..........#...................................
......................................#...................................................................#.#.#..................#
.......#...#.....#........#..............#................#.........................#.#...........#.#.............#.......#.......
...#.................#......#...........#.............#.....................................#.....................................
.#...........................................................................................................#....................
............#..........#.......................#...........................................................................#....#.
......#....#...#.........................#......#......................##....#.......#.....................#....#.................
....................................#..........................#.......#.......#......................................#........##.
...................#..................................................................................#..............#.#..........
....#..........................#.....................#.#.........#...#......#..#....#.............................................
..................#......#................#........................................#...#........#.................................
...............................#.........#..................................................#.....................................
..................#..............................................#...............#...........#..#.................................
...........................#........................................................#........#....................................
.................#.......#.........##.............#...#....#......................#.......#.......................................
...........#...............#........................................................................#.#...........................
...........#..........#..........................#.....................#....#.........#...................##...#.........#........
.......#.............#........#...........................................#.................................................#.#...
.....................#..................................#.#......#...................#.........................#...#....#..##.....
.......#...................#.............#..#..................................................................#..................
..#........#........................#............#..#...#...........................#......................................#.#....
.............................#..#.......#.........#.....................................................................##...#....
..............##................#........................#..................................................#.....#...#...........
.............#..............#......#..............................................................#...................#...........
#...#............#...........##.............#..........................................#..........................................
..........................#.....#...................#....................#................#.......................................
.....................................................#..................................................................#...#.....
..................#.#........#....#.#.#..#...............................................#.....###..#.........................#...
.#...#.........#..........#.......................................................................#.#............#............#...
...#..............................#.............................#.#............................................#..................
#................................................#..#..........................................................#...............#.#
........................................#.............#..............#...............#.........#...#..............................
..............................#.................#..................#................#.....#.......#..........#....................
............#.......#...........#.........................................................................................#.......
#.#..............................#................#.#...................#.....................#.....................#......#......
.....#..#.......##...........................................#............................#.......................................
.......#..#..#.........#..........................#.#....#..........................#...#........................#.....#.........."""

# puzzle_input="""....#.....
# .........#
# ..........
# ..#.......
# .......#..
# ..........
# .#..^.....
# ........#.
# #.........
# ......#..."""

grid = []
for row in puzzle_input.split("\n"):
    grid.append(list(row))

def travel(srow, scol, direction, sum):
    # Direction tuple for up, right, down, left, i.e. Turning right at each index.
    directions = [(-1, 0), (0, 1), (1, 0), (0, -1)]
    r = srow
    c = scol
    while 0 <= r < len(grid) and 0 <= c < len(grid[r]):
        dx, dy = directions[direction % 4]

        # Found an obstacle
        if grid[r][c] == '#':
            # Go 1 step back and change direction
            r -= dx
            c -= dy
            direction += 1
        # Never Visited
        elif grid[r][c] == '.':
            sum += 1
            grid[r][c] = 'X'
            r += dx
            c += dy
        # Already visited
        else:
            r += dx
            c += dy
    return sum

sum = 0
for row in range(len(grid)):
    if '^' in grid[row]:
        col = grid[row].index('^')
        grid[row][col] = 'X'
        sum = travel(row, col, 0, 1)
        break

print("Part 1: ", sum)

# Part 2
# Make a set of the entire guard route
# Place obstacles in each coordinate provided the guard isn't already there
# Check in each obstacle iteration that if there is an infinite loop by making a set of (coordinates, direction)

grid = []
for row in puzzle_input.split("\n"):
    grid.append(list(row))

def travel2(srow, scol, direction):
    travel_path = set()
    # Direction tuple for up, right, down, left, i.e. Turning right at each index.
    directions = [(-1, 0), (0, 1), (1, 0), (0, -1)]
    r = srow
    c = scol
    while 0 <= r < len(grid) and 0 <= c < len(grid[r]):
        dx, dy = directions[direction % 4]

        # Found an obstacle
        if grid[r][c] == '#':
            # Go 1 step back and change direction
            r -= dx
            c -= dy
            direction += 1
        # Never Visited
        elif grid[r][c] == '.':
            travel_path.add((r, c))
            r += dx
            c += dy
        # Already visited
        else:
            r += dx
            c += dy
    return travel_path

for row in range(len(grid)):
    if '^' in grid[row]:
        col = grid[row].index('^')
        break

travel_path = travel2(row, col, 0)

# Make it return 1 if there is infinite loop else 0
def check_infinite_loop(srow, scol, ox, oy, grid):
    grid_copy = copy.deepcopy(grid)
    grid_copy[ox][oy] = '#'

    directions = [(-1, 0), (0, 1), (1, 0), (0, -1)]
    direction = 0
    # Original starting position
    r, c = srow, scol

    travel_path_loop = set()
    while 0 <= r < len(grid_copy) and 0 <= c < len(grid_copy[r]):
        dx, dy = directions[direction % 4]
        # If the coordinated has already been visited and the direction is same, then it is an infinite loop
        if (r, c, (dx, dy)) in travel_path_loop:
            return 1

        if grid_copy[r][c] == '#':
            # Go back and change direction
            r -= dx
            c -= dy
            direction += 1
        elif grid_copy[r][c] == '.':
            # Add coordinates along with direction to the set
            travel_path_loop.add((r, c, (dx, dy)))
            r += dx
            c += dy
        else:
            r += dx
            c += dy
    return 0

n_obstacles = 0
for coordinate in tqdm(travel_path):
    r, c = coordinate
    if grid[r][c] == '^':
        continue
    else:
        n_obstacles += check_infinite_loop(row, col, r, c, grid)

print("Part 2: ", n_obstacles)
